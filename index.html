<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1" />
    <link rel="stylesheet" href="https://d396qusza40orc.cloudfront.net/startup%2Fcode%2Fbootstrap-combined.no-icons.min.css">
    <title>Location API Sample</title>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places&sensor=false"></script>

<script>
var map;
var directionsService = new google.maps.DirectionsService();
var directionsRenderer;
var infowindow;

function initialize() {
// Show current location on a map with local places.
// Using callback function to get current location, because it is asynchronous programming.
    navigator.geolocation.getCurrentPosition(function(position){
	console.log('Your current position is: ');
	console.log('Lat: ' + position.coords.latitude);
	console.log('Long: ' + position.coords.longitude);
	console.log('More ore less: ' + position.coords.accuracy + 'meter');
	var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
	if(latlng == null) {
	    latlng = new google.maps.LatLng(-33.8665433, 151.1956316);
	}
	var myOption = {
	    zoom: 15,
	    center: latlng,
	    mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	map = new google.maps.Map(document.getElementById('map'), myOption);
	var marker = new google.maps.Marker({
	    position: latlng,
	    map: map,
	    title: 'Current location'
	});
	var request = {
	    location: latlng,
	    radius: 500,
	    types: ['store']
	};

	// Create an instance for direction service, and set map for it.
	directionsRenderer = new google.maps.DirectionsRenderer();
	directionsRenderer.setMap(map);

	// Create an instance for info window, and create a new service with map.
	infowindow = new google.maps.InfoWindow();
	var service = new google.maps.places.PlacesService(map);
	service.nearbySearch(request, callback);

document.getElementById("loclat").innerHTML = position.coords.latitude;
document.getElementById("loclng").innerHTML = position.coords.longitude;

    }, function(error) {
	var message = "";
	switch(error.code){
	    case error.POSITION_UNAVAILABLE:
	    message = "Location unavailable!!!";
	    break;
	    case error.PERMISSION_DENIED:
	    message = "Not permitted to use location!!!";
	    break;
	    case error.PERMISSION_DENIED_TIMEOUT:
	    message = "Time out to get location!!!";
	    break;
	}
	window.alert(message);
    });
}
	
// Callback fuction to show bubbles on map in an iterative fashion.
function callback(results, status) {
    if (status == google.maps.places.PlacesServiceStatus.OK) {
	for(var i=0; i<results.length; i++) {
	    createMarker(results[i]);
	}
    }
}

function createMarker(place) {
    var marker = new google.maps.Marker({
	map: map,
	position: place.geometry.location
    });
    google.maps.event.addListener(marker, 'click', function(){
	infowindow.setContent(place.name);
	infowindow.open(map, this);
    });
}

function calcRoute() {
// Calculate route direction and show route on map when a destination is selected.
// Using callback function to get current location, because it is asynchronous programming.
// To get current location, I use "getCurrentPosition" rather than "watchPosition".
    navigator.geolocation.getCurrentPosition(function(position) {
	var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
	console.log('Your current position is: ');
	console.log('Lat: ' + position.coords.latitude);
	console.log('Long: ' + position.coords.longitude);
	console.log('More ore less: ' + position.coords.accuracy + 'meter');
	var end = document.getElementById('end').value;
	var request = {
	    origin: latlng,
	    destination: end, 
	    travelMode: google.maps.TravelMode.DRIVING
	};
	directionsService.route(request, function(result, status){
	    if(status == google.maps.DirectionsStatus.OK) {
		directionsRenderer.setDirections(result);
	    }
	});
    });
}

// When window is resized, center the current location on map
google.maps.event.addDomListener(window, "resize", function() {
    var center = map.getCenter();
    google.maps.event.trigger(map, "resize");
    map.setCenter(center);
});

/*google.maps.event.addDomListener(window, 'load', initialize);*/

</script>

    <style type="text/css">
      body { height: 100%; margin: 0px; padding: 1px }
      #map {
      width: 100%;
      height: 500px;
      border: solid lpx #ccc;
      }
    </style>
  </head>

  <body onload="initialize();">

    <div class="navbar navbar-default navbar-fixed-top">
      <div class="navbar-inner">
	<div class="container-fluid">
	  <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
	    <span class="icon-bar"></span>
	    <span class="icon-bar"></span>
	    <span class="icon-bar"></span>
	  </button>
	  <a class="brand" href="#">MapSample</a>
	  <div class="nav-collapse collapse">
	    <ul class="nav">
	      <li class="active"><a href="#">Map</a></li>
	      <li><a href="#music">Music</a></li>
	      <li><a href="#setting">Setting</a></li>
	    </ul>
	    <form class="navbar-form navbar-left" role="search">
	      <input type="text" class="form-control" placeholder="Search">
	      <button type="submit" class="btn btn-default" onclick="updateMap();">Submit</button>
	    </form>
	  </div><!--/.nav-collapse -->
	</div><!--/.container-->
      </div>

      <div id="panel" style="float:left">
	<b> Destination: </b>
	<select id="end" onchange="calcRoute();">
	  <option value="Mountain View, CA">Mountain View</option>
	  <option value="Palo Alto, CA">Palo Alto</option>
	  <option value="San Francisco, CA">San Francisco</option>
	  <option value="Los Angeles, CA">Los Angeles</option>
	  <option value="San Diego, CA">San Diego</option>
	</select>
      </div>
      <div id="loc" style="float:left">
	  <div id="loclat" style="float:left">  </div>
	  <div id="loclng" style="float:left"></div>
      </div>
      <div id="map"></div>
      <div id="message"></div>
    </div>
  </body>
</html>
